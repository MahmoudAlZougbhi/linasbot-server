services:
  postgres:
    image: postgres:15
    container_name: linas_postgres_prod
    environment:
      POSTGRES_DB: linasbot
      POSTGRES_USER: botuser
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped
    networks:
      - linas_network

  redis:
    image: redis:7-alpine
    container_name: linas_redis_prod
    restart: unless-stopped
    networks:
      - linas_network

  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile.prod
    container_name: linas_backend_prod
    environment:
      - DATABASE_URL=postgresql://botuser:${DB_PASSWORD}@postgres:5432/linasbot
      - REDIS_URL=redis://redis:6379
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - WHATSAPP_API_TOKEN=${WHATSAPP_API_TOKEN}
      - WHATSAPP_PHONE_NUMBER_ID=${WHATSAPP_PHONE_NUMBER_ID}
      - WHATSAPP_BUSINESS_ACCOUNT_ID=${WHATSAPP_BUSINESS_ACCOUNT_ID}
      - DIALOG360_API_KEY=${DIALOG360_API_KEY}
      - DIALOG360_SANDBOX=${DIALOG360_SANDBOX}
      - DIALOG360_PHONE_NUMBER=${DIALOG360_PHONE_NUMBER}
      - WHATSAPP_TO=${WHATSAPP_TO}
      - TRAINER_WHATSAPP_NUMBER=${TRAINER_WHATSAPP_NUMBER}
      - WHATSAPP_WEBHOOK_VERIFY_TOKEN=${WHATSAPP_WEBHOOK_VERIFY_TOKEN}
      - LINASLASER_API_BASE_URL=${LINASLASER_API_BASE_URL}
      - LINASLASER_API_TOKEN=${LINASLASER_API_TOKEN}
    depends_on:
      - postgres
      - redis
    ports:
      - "8003:8003"
    restart: unless-stopped
    networks:
      - linas_network

  dashboard:
    build:
      context: ./dashboard
      dockerfile: Dockerfile.prod
      args:
        REACT_APP_API_URL: ${REACT_APP_API_URL:-http://localhost:8003}
        REACT_APP_WS_URL: ${REACT_APP_WS_URL:-ws://localhost:8003}
    container_name: linas_dashboard_prod
    depends_on:
      - backend
    ports:
      - "3000:80"
    restart: unless-stopped
    networks:
      - linas_network

volumes:
  postgres_data:

networks:
  linas_network:
    driver: bridge
