services:
  # PostgreSQL Database
  postgres:
    image: postgres:15
    container_name: linas_postgres
    environment:
      POSTGRES_DB: linasbot
      POSTGRES_USER: botuser
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    restart: unless-stopped
    networks:
      - linas_network

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: linas_redis
    ports:
      - "6379:6379"
    restart: unless-stopped
    networks:
      - linas_network

  # Backend (Python Bot + API)
  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile
    container_name: linas_backend
    environment:
      - LINASBOT_DATA_ROOT=/opt/linasbot_data
      - DATABASE_URL=postgresql://botuser:${DB_PASSWORD}@postgres:5432/linasbot
      - REDIS_URL=redis://redis:6379
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - WHATSAPP_API_TOKEN=${WHATSAPP_API_TOKEN}
      - WHATSAPP_PHONE_NUMBER_ID=${WHATSAPP_PHONE_NUMBER_ID}
      - WHATSAPP_BUSINESS_ACCOUNT_ID=${WHATSAPP_BUSINESS_ACCOUNT_ID}
      - DIALOG360_API_KEY=${DIALOG360_API_KEY}
      - DIALOG360_SANDBOX=${DIALOG360_SANDBOX}
      - DIALOG360_PHONE_NUMBER=${DIALOG360_PHONE_NUMBER}
      - WHATSAPP_TO=${WHATSAPP_TO}
      - TRAINER_WHATSAPP_NUMBER=${TRAINER_WHATSAPP_NUMBER}
      - WHATSAPP_WEBHOOK_VERIFY_TOKEN=${WHATSAPP_WEBHOOK_VERIFY_TOKEN}
      - LINASLASER_API_BASE_URL=${LINASLASER_API_BASE_URL}
      - LINASLASER_API_TOKEN=${LINASLASER_API_TOKEN}
    volumes:
      - ./:/app
      - ./data:/app/data
      - linasbot_data:/opt/linasbot_data
    ports:
      - "8003:8003"
    depends_on:
      - postgres
      - redis
    restart: unless-stopped
    networks:
      - linas_network

  # Dashboard (React Frontend)
  dashboard:
    build:
      context: ./dashboard
      dockerfile: Dockerfile
    container_name: linas_dashboard
    environment:
      - REACT_APP_API_URL=https://bot.tradershubs.site/api
      - REACT_APP_WS_URL=wss://bot.tradershubs.site/ws
    ports:
      - "3000:3000"
    depends_on:
      - backend
    restart: unless-stopped
    networks:
      - linas_network

volumes:
  postgres_data:
  linasbot_data:

networks:
  linas_network:
    driver: bridge
